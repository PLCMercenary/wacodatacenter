{{ define "main" }}
<div class="container mt-5 pt-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold">Community Calendar</h1>
                <p class="lead text-muted">Upcoming meetings, events, and opportunities to engage</p>
            </div>

            {{ $now := now }}
            {{ $highlightedEvents := slice }}
            {{ $upcomingEvents := slice }}
            
            {{/* Separate highlighted and regular events, filter out past events */}}
            {{ range .Params.events }}
                {{ $eventDate := time .date }}
                {{ if ge $eventDate $now }}
                    {{ if .highlight }}
                        {{ $highlightedEvents = $highlightedEvents | append . }}
                    {{ else }}
                        {{ $upcomingEvents = $upcomingEvents | append . }}
                    {{ end }}
                {{ end }}
            {{ end }}

            {{/* Next Important Meeting Section */}}
            {{ if $highlightedEvents }}
                {{ $nextEvent := index $highlightedEvents 0 }}
                <div class="card mb-5" style="border: 3px solid #fd7e14; background: linear-gradient(135deg, #fff5e6 0%, #ffffff 100%);">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-3">
                            <span class="badge bg-warning text-dark me-2" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                                <i class="fas fa-star me-1"></i>NEXT IMPORTANT MEETING
                            </span>
                        </div>
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h2 class="mb-2">{{ $nextEvent.title }}</h2>
                                <p class="mb-2"><i class="fas fa-calendar me-2 text-warning"></i><strong>{{ dateFormat "Monday, January 2, 2006" (time $nextEvent.date) }}</strong> at {{ $nextEvent.time }}</p>
                                <p class="mb-2"><i class="fas fa-map-marker-alt me-2 text-warning"></i>{{ $nextEvent.location }}</p>
                                {{ if $nextEvent.notes }}
                                <p class="text-muted mb-0"><em>{{ $nextEvent.notes }}</em></p>
                                {{ end }}
                            </div>
                            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                                {{ if $nextEvent.agenda_url }}
                                <a href="{{ $nextEvent.agenda_url }}" class="btn btn-warning btn-lg" target="_blank">
                                    <i class="fas fa-file-alt me-2"></i>View Agenda
                                </a>
                                {{ end }}
                            </div>
                        </div>
                    </div>
                </div>

                {{/* Other Important Meetings - Show only next 3 */}}
                {{ if gt (len $highlightedEvents) 1 }}
                <h3 class="mt-5 mb-4"><i class="fas fa-star text-warning me-2"></i>Other Important Meetings</h3>
                <div class="row">
                    {{ range first 3 (after 1 $highlightedEvents) }}
                    <div class="col-md-6 mb-4">
                        <div class="card h-100" style="border-left: 4px solid #fd7e14;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title mb-0">{{ .title }}</h5>
                                    <span class="badge bg-secondary">{{ .category }}</span>
                                </div>
                                <p class="text-muted mb-2">
                                    <i class="fas fa-calendar me-2"></i>{{ dateFormat "Mon, Jan 2" (time .date) }} at {{ .time }}
                                </p>
                                <p class="text-muted mb-2">
                                    <i class="fas fa-map-marker-alt me-2"></i>{{ .location }}
                                </p>
                                {{ if .notes }}
                                <p class="small text-muted mb-0">{{ .notes }}</p>
                                {{ end }}
                                {{ if .agenda_url }}
                                <a href="{{ .agenda_url }}" class="btn btn-outline-warning btn-sm mt-2" target="_blank">
                                    <i class="fas fa-file-alt me-1"></i>Agenda
                                </a>
                                {{ end }}
                            </div>
                        </div>
                    </div>
                    {{ end }}
                </div>
                {{ end }}
            {{ end }}

            {{/* All Upcoming Events by Month */}}
            <h3 class="mt-5 mb-4"><i class="fas fa-calendar-alt me-2"></i>All Upcoming Events</h3>
            
            {{ $eventsByMonth := dict }}
            {{ range $upcomingEvents }}
                {{ $monthKey := dateFormat "2006-01" (time .date) }}
                {{ $monthName := dateFormat "January 2006" (time .date) }}
                {{ $events := index $eventsByMonth $monthKey | default (dict "month" $monthName "events" slice) }}
                {{ $newEvents := $events.events | append . }}
                {{ $eventsByMonth = merge $eventsByMonth (dict $monthKey (dict "month" $monthName "events" $newEvents)) }}
            {{ end }}

            {{ range $monthKey, $monthData := $eventsByMonth }}
            <div class="mb-5">
                <h4 class="border-bottom pb-2 mb-3">{{ $monthData.month }}</h4>
                <div class="list-group">
                    {{ range $monthData.events }}
                    <div class="list-group-item{{ if .canceled }} list-group-item-secondary{{ end }}">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="mb-1">
                                    {{ .title }}
                                    {{ if .canceled }}
                                    <span class="badge bg-danger ms-2">CANCELED</span>
                                    {{ end }}
                                </h6>
                                <p class="text-muted mb-1 small">
                                    <i class="fas fa-calendar me-2"></i>{{ dateFormat "Monday, January 2" (time .date) }} at {{ .time }}
                                    <span class="mx-2">|</span>
                                    <i class="fas fa-map-marker-alt me-2"></i>{{ .location }}
                                </p>
                                {{ if .notes }}
                                <p class="small text-muted mb-0">{{ .notes }}</p>
                                {{ end }}
                            </div>
                            <div class="col-md-4 text-md-end">
                                <span class="badge bg-light text-dark">{{ .category }}</span>
                                {{ if .agenda_url }}
                                <a href="{{ .agenda_url }}" class="btn btn-sm btn-outline-primary ms-2" target="_blank">
                                    <i class="fas fa-file-alt"></i> Agenda
                                </a>
                                {{ end }}
                            </div>
                        </div>
                    </div>
                    {{ end }}
                </div>
            </div>
            {{ end }}

            {{ if not $upcomingEvents }}
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>No additional events scheduled at this time. Check back soon!
            </div>
            {{ end }}

            <div class="alert alert-secondary mt-5">
                <p class="mb-2"><strong>How to Stay Updated:</strong></p>
                <ul class="mb-0">
                    <li>This calendar is updated regularly as new meetings are scheduled</li>
                    <li>Agendas are posted as they become available</li>
                    <li><a href="/contact/" class="alert-link">Sign up for email alerts</a> to get notified of important meetings</li>
                    <li>Join our <a href="https://www.facebook.com/share/g/17cFKqY3q8/?mibextid=wwXIfr" class="alert-link" target="_blank">Facebook group</a> for real-time updates</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{{ end }}
